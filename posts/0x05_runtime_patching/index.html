<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="generator" content="Hugo 0.74.3" />

  <title>0x05 Runtime patching &middot; dee</title>

  <meta name="description" content="" />

  

<meta itemprop="name" content="0x05 Runtime patching">
<meta itemprop="description" content="Runtime patching Runtime patching is the process of patching instructions or variables in a process during it&rsquo;s runtime.">
<meta itemprop="datePublished" content="2020-08-20T23:07:00+02:00" />
<meta itemprop="dateModified" content="2020-08-20T23:07:00+02:00" />
<meta itemprop="wordCount" content="508">



<meta itemprop="keywords" content="" />


<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="0x05 Runtime patching"/>
<meta name="twitter:description" content="Runtime patching Runtime patching is the process of patching instructions or variables in a process during it&rsquo;s runtime."/>


<meta property="og:title" content="0x05 Runtime patching" />
<meta property="og:description" content="Runtime patching Runtime patching is the process of patching instructions or variables in a process during it&rsquo;s runtime." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://dagmarazawada.github.io/posts/0x05_runtime_patching/" />
<meta property="article:published_time" content="2020-08-20T23:07:00+02:00" />
<meta property="article:modified_time" content="2020-08-20T23:07:00+02:00" />



  

  <link type="text/css"
        rel="stylesheet"
        href="/css/print.css"
        media="print">

  <link type="text/css"
        rel="stylesheet"
        href="/css/poole.css">

  <link type="text/css"
        rel="stylesheet"
        href="/css/hyde.css">

  
<style type="text/css">
  .sidebar {
    background-color: #333;
  }

  .read-more-link a {
    border-color: #333;
  }

  .pagination li a {
    color: #333;
    border: 1px solid #333;
  }

  .pagination li.active a {
    background-color: #333;
  }

  .pagination li a:hover {
    background-color: #333;
    opacity: 0.75;
  }

  footer a,
  .content a,
  .related-posts li a:hover {
    color: #333;
  }
</style>



  <link type="text/css" rel="stylesheet" href="/css/blog.css">

  <link rel="stylesheet"
        href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700&display=swap">

  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css"
        integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk="
        crossorigin="anonymous" />

  <link rel="apple-touch-icon-precomposed"
        sizes="144x144"
        href="/apple-touch-icon-144-precomposed.png">

  <link rel="shortcut icon" href="/favicon.png">

  
  </head>
<body>
  <aside class="sidebar">
  <div class="container">
    <div class="sidebar-about">
      
        
        <div class="author-image">
          <img src="/images/profile.png" class="img-circle img-headshot center" alt="Profile Picture">
        </div>
        
      

      <h1>dee</h1>

      
      <p class="lead">ARM &amp; iOS exploiting</p>
      
    </div>

    <nav>
      <ul class="sidebar-nav">
        <li>
          <a href="https://dagmarazawada.github.io">Home</a>
        </li>
        <li>
          <a href="/posts/">Posts</a>
        </li><li>
          <a href="/about/">About</a>
        </li><li>
          <a href="/resources/">Resources</a>
        </li>
      </ul>
    </nav>

    <section class="social-icons">
      
      <a href="https://www.linkedin.com/in/dagmarazawada/" rel="me" title="Linkedin" target="_blank">
        <i class="fab fa-linkedin" aria-hidden="true"></i>
      </a>
      
      <a href="#" rel="me" title="GitHub" target="_blank">
        <i class="fab fa-github" aria-hidden="true"></i>
      </a>
      
      <a href="#" rel="me" title="Twitter" target="_blank">
        <i class="fab fa-twitter" aria-hidden="true"></i>
      </a>
      
    </section>
  </div>
</aside>


  <main class="content container">
  <div class="post">
  <h1>0x05 Runtime patching</h1>

  <div class="post-date">
    <time datetime="2020-08-20T23:07:00&#43;0200">Aug 20, 2020</time> &middot; 3 min read
  </div>

  <h2 id="runtime-patching">Runtime patching</h2>
<p>Runtime patching is the process of patching instructions or variables in a process during it&rsquo;s runtime. Oppose to opening the binary in a disassembler, replacing instructions and producing a modified executable, runtime patching with Return Oriented Programming does not involve modifying the executable file as all of the patches are applied to the program as it is running.</p>
<p>Why do we need this? While simply statically patching a binary and producing a new executable is easier, it is not possible when attempting to patch the iOS kernel or another important process in an embedded system. With the iOS kernel, patching invalidates it&rsquo;s digital code signature which will result in it being rejected by iBoot during boot time (unless iBoot is also patched). Therefore the iOS kernel must have it&rsquo;s security features patched while it is already running through the user of a ROP payload.</p>
<p>To apply patches to a running process using ROP, first we need a way to allow us to write arbitrary data to a memory location of our choice.</p>
<p>This isn&rsquo;t possible when working with simple programs as the area of memory that stores the actual instructions (__TEXT) is marked as Non-Writeable :sad: This means that attempting to overwrite instructions with our own will cause a crash and the exploit will fail. To workaround this, we must modify the kernel to be able to modify the page tables. So in this tutorial we will only attempt to patch __DATA section as this area of memory is marked as Writeable.</p>
<p>To be able to write to an arbitrary memory location, we need to use a special type of ROP gadget. These types of gadgets are known as &ldquo;write gadgets&rdquo; as they allow us to specific the data and the address in memory to write it to.</p>
<p>Let&rsquo;s prepare app for testing:</p>
<h2 id="0x05c">0x05.c</h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">#import &lt;stdio.h&gt;
</span><span style="color:#75715e">#import &lt;string.h&gt;
</span><span style="color:#75715e">#import &lt;unistd.h&gt;
</span><span style="color:#75715e">#import &lt;stdlib.h&gt;
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">int</span> internal_mode <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;

<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">func1</span>(){
	printf(<span style="color:#e6db74">&#34;Hello world! Welcome to a function - an function that does absolutely nothing!</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
}

<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">func_internal</span>(){
	printf(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x1b</span><span style="color:#e6db74">[33mDeveloper-only functionality ;P</span><span style="color:#ae81ff">\x1b</span><span style="color:#e6db74">[0m</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">What would you like to do?</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">[1] Touch a file</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">[2] Spawn a shell</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">[3] Quit function</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
    
    <span style="color:#66d9ef">char</span> input[<span style="color:#ae81ff">1</span>];
    scanf(<span style="color:#e6db74">&#34;%s&#34;</span>,input);
    
    <span style="color:#66d9ef">if</span> ( <span style="color:#f92672">*</span>input <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;1&#39;</span> ){
        system(<span style="color:#e6db74">&#34;touch /created_by_roplevel3&#34;</span>);
    } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> ( <span style="color:#f92672">*</span>input <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;2&#39;</span>) {
        system(<span style="color:#e6db74">&#34;/bin/sh&#34;</span>);
    } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> ( <span style="color:#f92672">*</span>input <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;3&#39;</span> ) {
        exit(<span style="color:#ae81ff">0</span>);
    } <span style="color:#66d9ef">else</span> {
        printf(<span style="color:#e6db74">&#34;Invalid option&#34;</span>);
    }
}

<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">validate</span>(<span style="color:#66d9ef">char</span> func_id[]){
    <span style="color:#66d9ef">if</span> ( <span style="color:#f92672">*</span>func_id <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;1&#39;</span>) {
        func1();
    } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> ( <span style="color:#f92672">*</span>func_id <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;2&#39;</span> ) {
        <span style="color:#66d9ef">if</span> (internal_mode <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {
            printf(<span style="color:#e6db74">&#34;You do not have permission to launch this function.</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
        } 
        <span style="color:#66d9ef">else</span> {
            func_internal();
        }
    } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> ( <span style="color:#f92672">*</span>func_id <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;3&#39;</span> ) {
        exit(<span style="color:#ae81ff">0</span>);
    } <span style="color:#66d9ef">else</span> {
        printf(<span style="color:#e6db74">&#34;Invalid choice.</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
    }
}

<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">write_anywhere</span>(){
	__asm__(<span style="color:#e6db74">&#34;str r0, [r1]&#34;</span>);
}

<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">gadget</span>(){
	__asm__(<span style="color:#e6db74">&#34;pop {r0,r1,pc}&#34;</span>);
}

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>(){
    <span style="color:#66d9ef">int</span> a <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
    printf(<span style="color:#e6db74">&#34;0x04 Runtime patching tests</span><span style="color:#ae81ff">\n\n</span><span style="color:#e6db74">&#34;</span>);
    <span style="color:#66d9ef">while</span> (a <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>) {
        printf(<span style="color:#e6db74">&#34;Select an option:</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">[1] option 1</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">[2] option 2 (internal)</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">[3] exit</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
        <span style="color:#66d9ef">char</span> input[<span style="color:#ae81ff">8</span>];
        scanf(<span style="color:#e6db74">&#34;%s&#34;</span>, input);
        validate(input);    
    }
	<span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
}
</code></pre></div><p>Compile and sign:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ clang 0x05.c -fno-stack-protector -fno-pie -arch armv7 -mios-version-min<span style="color:#f92672">=</span><span style="color:#ae81ff">6</span> -mno-thumb -isysroot /var/root/theos/sdks/iPhoneOS10.3.sdk/ -o 0x05
$ ldid -S 0x05
</code></pre></div>
</div>


  </main>

  <footer>
  <div>
    &copy; dagmara 2020

    &middot; <a href="https://creativecommons.org/licenses/by-sa/4.0" target="_blank">CC BY-SA 4.0</a>

    
  </div>
</footer>


  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/js/all.min.js"
          integrity="sha256-MAgcygDRahs+F/Nk5Vz387whB4kSK9NXlDN3w58LLq0="
          crossorigin="anonymous"></script>

  

  
</body>
</html>
